<div class="panel" style="border-width: 1px;">
<div class="panelContent">
<p>
This tutorial is part of a Series:
</p>

<ul>
<li>Part I: Creating a Custom Resource Class
</li>

<li>
<a href="display/revolution20/Creating+a+Resource+Class+-+Step+2" title="Creating a Resource Class - Step 2">Part II: Handling our CRC Behavior</a>
</li>

<li>
<a href="display/revolution20/Creating+a+Resource+Class+-+Step+3" title="Creating a Resource Class - Step 3">Part III: Customizing the Controllers</a>
</li>

<li>
<a href="display/revolution20/Creating+a+Resource+Class+-+Step+4" title="Creating a Resource Class - Step 4">Part IV: Customizing the Processors</a>
</li>
</ul>
</div>
</div>

<p>
We're going to create a sample Custom Resource Class (CRC) that does a very simple task - it outputs a copyright on the bottom of a page with the current date. Yes, something this trivial should be done by placing a <a href="display/revolution20/Snippets" title="Snippets">Snippet</a> in your <a href="display/revolution20/Templates" title="Templates">Template</a>, but we want to illustrate the concept of CRCs using something very, very simple, so bear with us. <img class="emoticon" src="images/icons/emoticons/smile.gif" height="20" width="20" align="absmiddle" alt="" border="0" />
</p>

<p>
This page deals with Part I - creating the actual Custom Resource Class itself. <a href="display/revolution20/Creating+a+Resource+Class+-+Step+2" title="Creating a Resource Class - Step 2">Part II</a> will actually implement the behavior of appending the copyright. <a href="display/revolution20/Creating+a+Resource+Class+-+Step+3" title="Creating a Resource Class - Step 3">Part III</a> will deal with overriding the Controllers, and <a href="display/revolution20/Creating+a+Resource+Class+-+Step+4" title="Creating a Resource Class - Step 4">Part IV</a> will deal with overriding the Processors. The files used in this tutorial can be found on GitHub for reference: <a href="https://github.com/modxcms/CopyrightedResource" class="external-link" rel="nofollow">https://github.com/modxcms/CopyrightedResource</a>
</p>

<h2>
<a name="CreatingaResourceClass-CreateyourXMLSchema"></a>Create your XML Schema
</h2>

<p>
First, we are going to create a xPDO package using a schema (if you're not familiar on how to do this, please review the page on <a href="display/revolution20/Developing+an+Extra+in+MODX+Revolution" title="Developing an Extra in MODX Revolution">Developing an Extra in MODX Revolution</a> tutorial and/or the <a href="display/xPDO20/Defining+a+Schema" title="Defining a Schema">xPDO Defining a Schema</a> tutorial).
</p>

<p>
If you are planning on versioning this code in Git, your paths may be different, but ultimately you want your files to end up inside the <tt>core/components/your_component/</tt> directory. So for this tutorial our package is named "copyrightedresource", so we will create the schema file <tt>core/components/copyrightedresource/model/schema/copyrightedresource.mysql.schema.xml</tt>:
</p>

<pre class="brush: php">
    
&lt;?php
/**
 * Parses a MODX XML schema file in order to create the corresponding PHP classes
 * and (optionally) database tables.  Use this script when you are editing a MODX XML
 * schema file and you are using it as your basis for creating PHP classes.  Do not
 * use this script if you are trying to reverse-engineer existing database tables!
 *
 * See http://rtfm.modx.com/display/revolution20/Creating+a+Resource+Class
 * 
 * USAGE:
 * 1. Create this file in the docroot (webroot) of your MODX installation.
 * 2. Execute the file by visiting it in a browser, e.g. http://yoursite.com/parse_schema.php
 */
//------------------------------------------------------------------------------
//! CONFIGURATION
//------------------------------------------------------------------------------
// Your package shortname:
$package_name = 'copyrightedresource';

// Set this to false if you've started to customize the PHP classes, otherwise
// your changes will be overwritten!
$regenerate_classes = true;


//------------------------------------------------------------------------------
//  DO NOT TOUCH BELOW THIS LINE
//------------------------------------------------------------------------------
require_once 'config.core.php';

if (!defined('MODX_CORE_PATH')) {
    print_msg('&lt;h1&gt;Parsing Error&lt;/h1&gt;
        &lt;p&gt;MODX_CORE_PATH not defined! Did you include the correct config file?&lt;/p&gt;');
    exit;
}
require_once MODX_CORE_PATH . 'config/config.inc.php';
$xpdo_path = strtr(MODX_CORE_PATH . 'xpdo/xpdo.class.php', '\\', '/');
include_once ( $xpdo_path );
 
// A few definitions of files/folders:
$package_dir = MODX_CORE_PATH . "components/$package_name/";
$model_dir = MODX_CORE_PATH . "components/$package_name/model/";
$class_dir = MODX_CORE_PATH . "components/$package_name/model/$package_name";
$schema_dir = MODX_CORE_PATH . "components/$package_name/model/schema";
$mysql_class_dir = MODX_CORE_PATH . "components/$package_name/model/$package_name/mysql";
$xml_schema_file = MODX_CORE_PATH . "components/$package_name/model/schema/$package_name.mysql.schema.xml";
 
// A few variables used to track execution times.
$mtime= microtime();
$mtime= explode(' ', $mtime);
$mtime= $mtime[1] + $mtime[0];
$tstart= $mtime;
 
// Validations
if ( empty($package_name) ) {
    print_msg('&lt;h1&gt;Parsing Error&lt;/h1&gt;
        &lt;p&gt;The $package_name cannot be empty!  Please adjust the configuration and try again.&lt;/p&gt;');
    exit;
}
 
// Create directories if necessary
$dirs = array($package_dir, $schema_dir ,$mysql_class_dir, $class_dir);
 
foreach ($dirs as $d) {
    if ( !file_exists($d) ) {
        if ( !mkdir($d, 0777, true) ) {
            print_msg( sprintf('&lt;h1&gt;Parsing Error&lt;/h1&gt;
                &lt;p&gt;Error creating &lt;code&gt;%s&lt;/code&gt;&lt;/p&gt;
                &lt;p&gt;Create the directory (and its parents) and try again.&lt;/p&gt;'
                , $d
            ));
            exit;
        }
    }
    if ( !is_writable($d) ) {
        print_msg( sprintf('&lt;h1&gt;Parsing Error&lt;/h1&gt;
            &lt;p&gt;The &lt;code&gt;%s&lt;/code&gt; directory is not writable by PHP.&lt;/p&gt;
            &lt;p&gt;Adjust the permissions and try again.&lt;/p&gt;'
        , $d));
        exit;
    }
}
 

print_msg( sprintf('&lt;br/&gt;&lt;strong&gt;Ok:&lt;/strong&gt; The necessary directories exist and have the correct permissions inside of &lt;br/&gt;
        &lt;code&gt;%s&lt;/code&gt;', $package_dir));
 
if (file_exists($xml_schema_file)) {
    print_msg( sprintf('&lt;br/&gt;&lt;strong&gt;Ok:&lt;/strong&gt; Using existing XML schema file:&lt;br/&gt;&lt;code&gt;%s&lt;/code&gt;',$xml_schema_file));
}

$xpdo = new xPDO("mysql:host=$database_server;dbname=$dbase", $database_user, $database_password, $table_prefix);
$xpdo-&gt;setLogLevel(xPDO::LOG_LEVEL_INFO);
$xpdo-&gt;setLogTarget(XPDO_CLI_MODE ? 'ECHO' : 'HTML');

$manager = $xpdo-&gt;getManager();
$generator = $manager-&gt;getGenerator();

// Use this to generate classes and maps from your schema
if ($regenerate_classes) { 
    print_msg('&lt;br/&gt;Attempting to remove/regenerate class files...');
    delete_class_files($class_dir);
    delete_class_files($mysql_class_dir);
}

$generator-&gt;parseSchema($xml_schema_file,$model_dir);


$mtime= microtime();
$mtime= explode(" ", $mtime);
$mtime= $mtime[1] + $mtime[0];
$tend= $mtime;
$totalTime= ($tend - $tstart);
$totalTime= sprintf("%2.4f s", $totalTime);

print_msg("&lt;br/&gt;&lt;br/&gt;&lt;strong&gt;Finished!&lt;/strong&gt; Execution time: {$totalTime}&lt;br/&gt;");
print_msg("&lt;br/&gt;Check &lt;code&gt;$class_dir&lt;/code&gt; for your newly generated class files!"); 
exit();

//------------------------------------------------------------------------------
//! FUNCTIONS
//------------------------------------------------------------------------------
/**
 * Deletes the MODX class files in a given directory.
 *
 * @param string $dir: full path to directory containing class files you wish to delete.
 * @return void
 */
function delete_class_files($dir) {
    global $verbose;
 
    $all_files = scandir($dir);
    foreach ( $all_files as $f ) {
        if ( preg_match('#\.class\.php$#i', $f) || preg_match('#\.map\.inc\.php$#i', $f)) {
            if ( unlink("$dir/$f") ) {
                if ($verbose) {
                    print_msg( sprintf('&lt;br/&gt;Deleted file: &lt;code&gt;%s/%s&lt;/code&gt;',$dir,$f) );
                }
            }
            else {
                print_msg( sprintf('&lt;br/&gt;Failed to delete file: &lt;code&gt;%s/%s&lt;/code&gt;',$dir,$f) );
            }
        }
    }
}

/**
 * Formats/prints messages. HTML is stripped if this is run via the command line.
 *
 * @param string $msg to be printed
 * @return void this actually prints data to stdout
 */
function print_msg($msg) {
    if ( php_sapi_name() == 'cli' ) {
        $msg = preg_replace('#&lt;br\s*/&gt;#i', "\n", $msg);
        $msg = preg_replace('#&lt;h1&gt;#i', '== ', $msg);
        $msg = preg_replace('#&lt;/h1&gt;#i', ' ==', $msg);
        $msg = preg_replace('#&lt;h2&gt;#i', '=== ', $msg);
        $msg = preg_replace('#&lt;/h2&gt;#i', ' ===', $msg);
        $msg = strip_tags($msg) . "\n";
    }
    print $msg;
}
?&gt;

    
</pre>
<p>
After this script runs, a handful of PHP files should have been created inside your <tt>core/components/copyrightedresource/model/</tt> directory. See the image below.
</p>

<p>
<span class="image-wrap" style=""><img src="download/attachments/36634952/copyrightedresource_class_files.png?version=1&amp;modificationDate=1360972022000" style="border: 1px solid black" /></span>
</p>

<p>
The <tt>copyrightedresource.class.php</tt> file should look like this:
</p>

<pre class="brush: php">
    
&lt;?php
class CopyrightedResource extends modResource {
    public $showInContextMenu = true;
    function __construct(xPDO &amp; $xpdo) {
        parent :: __construct($xpdo);
        $this-&gt;set('class_key','CopyrightedResource');
    }
}

    
</pre>
<p>
This forces the class_key to "CopyrightedResource", which is our class, and ensures our Resource class shows up in the left-hand tree's context menu. This is how we govern the value set in the modx_site_content "class_key" column.
</p>

<div class="warning">
You should <b>never</b> add fields to the modResource table (yes, some Extras have done this, but it's not the proper way). Rather, create a separate related table to join into, or use Revolution 2.2.1+'s new properties field to store extra data.
</div>

<h3>
<a name="CreatingaResourceClass-GettingFamiliarwiththemodResourceInterfaceInterfaceclass"></a>Getting Familiar with the modResourceInterface Interface class
</h3>

<p>
For those of you geeks who want to code responsibly, it's a very good idea to look at the parent class here, so have a look inside the <tt>core/model/modx/modresource.class.php</tt>.
</p>

<div class="tip">
<b>Code Responsibly</b>
<br />
Any time you extend a PHP class, you should look at the parent class, otherwise you won't know what you are implementing!
</div>

<p>
If you look in the modResource class file, you'll see at the top a PHP Interface that defines what methods <b>must</b> be defined for a CRC to work:
</p>

<pre class="brush: php">
    
Namespace: copyrightedresource
Core Path: {core_path}components/copyrightedresource/
Assets Path: {assets_path}components/copyrightedresource/

    
</pre>
<p>
<span class="image-wrap" style=""><img src="download/attachments/36634952/create_namespace.png?version=1&amp;modificationDate=1360974139000" style="border: 1px solid black" /></span>
</p>

<p>
Note the special placeholders you can use to refer to your directories.
</p>

<h3>
<a name="CreatingaResourceClass-AddingthegetControllerPathMethod"></a>Adding the getControllerPath Method
</h3>

<p>
Once you've added a namespace, we're going to add the getControllerPath method to our class by adding this to your <tt>copyrightedresource.class.php</tt> class:
</p>

<pre class="brush: php">
    public function getContextMenuText() {
  $this-&gt;xpdo-&gt;lexicon-&gt;load('copyrightedresource:default');
  return array(
    'text_create' =&gt; $this-&gt;xpdo-&gt;lexicon('copyrightedresource'),
    'text_create_here' =&gt; $this-&gt;xpdo-&gt;lexicon('copyrightedresource_create_here'),
  );
}
    
</pre>
<p>
This returns two translated strings that MODX will insert into the "Create" context menu when right-clicking on a node in the Resource tab on the left-hand tree.
</p>

<p>
Just to be clear, you don't necessarily <em>need</em> to use the MODX lexicon here. You could simply return the text like so:
</p>

<pre class="brush: php">
    
public function getResourceTypeName() {
  $this-&gt;xpdo-&gt;lexicon-&gt;load('copyrightedresource:default');
  return $this-&gt;xpdo-&gt;lexicon('copyrightedresource');
}
    
</pre>
<p>
Again, this could just return a string:
</p>

<pre class="brush: php">
    $modx-&gt;addExtensionPackage('copyrightedresource','/path/to/copyrightedresource/model/');
    
</pre>
<p>
Simply run this code once and MODX will automatically add it to the Extension Packages. Here is another sample script for helping you to do this:
</p>

<pre class="brush: php">
    
[{"copyrightedresource":{"path":"[[++core_path]]components/copyrightedresource/model/"}}]

    
</pre>
<p>
Note that you can use core_path placeholder in this path: this offers way to ensure that your path will work should you ever migrate your MODX site to a different server.
</p>

<p>
There's also a removeExtensionPackage as well for removing the package from MODX.
</p>

<div class="tip">
addExtensionPackage and removeExtensionPackage are very useful methods to add to a Resolver if you're building an Extra for your CRC so that this happens on install and uninstall.
</div>

<h2>
<a name="CreatingaResourceClass-Conclusion"></a>Conclusion
</h2>

<p>
Now, if you reload the page and right-click on a Resource in the tree, then move over "Create", you should see this:
</p>

<p>
<span class="image-wrap" style=""><img src="download/attachments/36634952/context-menu.png?version=1&amp;modificationDate=1322512993000" style="border: 0px solid black" /></span>
</p>

<p>
Fantastic! Now we've got our Custom Resource Class loaded, and we're ready to start actually getting into the nitty-gritty. <a href="display/revolution20/Creating+a+Resource+Class+-+Step+2" title="Creating a Resource Class - Step 2">Proceed onto Step 2</a>!
</p>